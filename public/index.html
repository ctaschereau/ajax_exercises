<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Super exercice</title>
	<style>
		#paintingPre {
			font-size: smaller;
		}

		.getMorePaint {
			padding: 0;
		}

		label {
			width: 100px;
			display: inline-block;
		}
	</style>
	<script src="https://code.jquery.com/jquery-3.2.1.js" integrity="sha256-DZAnKJ/6XZ9si04Hgrsxu/8s717jcIzLy3oi35EouyE=" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore.js"></script>
	<script type="application/javascript">

		let printError = (jqhxrErr) => {
			console.error(JSON.stringify(jqhxrErr.responseJSON, null, 4));
		};

		let applyPaint = (buttonEl, paintData) => {
			buttonEl.replaceWith(paintData);
		};

		let createButtonsForPainting = (paintingMetadata) => {
			let _testTemplateString = `<button class="getMorePaint" data-painting_id="<%= painting_id %>" data-painting_part_id="<%= id %>">ðŸŽ¨</button>\n`;
			let newDom = '';
			let templateFn = _.template(_testTemplateString);
			_.times(Math.floor(paintingMetadata.nbLines / 4), (idx) => {
				newDom += templateFn({
					painting_id : paintingMetadata.paintingID,
					id : idx * 4
				});
			});
			$('#start').hide();
			$('pre#paintingPre').html(newDom);
			$('.getMorePaint').click((event) => {
				let buttonEl = $(event.target);
				let paintingID = buttonEl.data('painting_id');
				let paintingPartID = buttonEl.data('painting_part_id');
				$.ajax({
					type : 'GET',
					url : `/painting/${paintingID}/${paintingPartID}`,
					success : (data) => {
						applyPaint(buttonEl, data);
					},
					error : printError
				});
			});
		};

		$(document).ready(function() {
			$('#start').click(() => {
				$.ajax({
					type : 'GET',
					url : '/painting',
					success : (data) => {
						console.info(data);
						let title = $('h1');
						title.html(title.html() + ' ' + data.paintingName);
						createButtonsForPainting(data);
					},
					error : printError
				});
			});
		});

		// ---------------------
		// Person form stuff
		// ---------------------
		$(document).ready(function() {
			let myForm = $('form#personForm');

			myForm.find('#delete').click(() => {
				$.ajax({
					type : 'DELETE',
					url : '/person/' + myForm.find('#id')[0].value,
					dataType: 'json',
					success : (data) => {
						myForm.find('h4').html('Person add form');
						myForm.find('#id').val(undefined);
						myForm.find('#firstName').val(undefined);
						myForm.find('#lastName').val(undefined);
						myForm.find('#delete').hide();
					},
					error : printError
				});
			});

			myForm.find('#submit').click(() => {
				let personData = {
					id : myForm.find('#id')[0].value,
					firstName : myForm.find('#firstName')[0].value,
					lastName : myForm.find('#lastName')[0].value,
				};
				if (personData.id) {
					$.ajax({
						type : 'POST',
						url : '/person/' + personData.id,
						dataType: 'json',
						data : personData,
						success : (data) => {
							console.info(data);
						},
						error : printError
					});
				} else {
					$.ajax({
						type : 'PUT',
						url : '/person',
						dataType: 'json',
						data : personData,
						success : (data) => {
							myForm.find('#id').val(data.id);
							myForm.find('h4').html('Person edit form');
							myForm.find('#delete').show();
						},
						error : printError
					});
				}
			});
		});
	</script>
</head>
<body>
<h1>AJAX...</h1>
<p>
	<button id="start">Start</button>
</p>
<pre id="paintingPre"></pre>
<hr>
<div id="personDiv">
	<form id="personForm">
		<h4>Person add form</h4>
		<label for="id">ID:</label><input id="id" type="text" disabled="disabled" /><br />
		<label for="firstName">First name:</label><input id="firstName" type="text" /><br />
		<label for="lastName">Last name:</label><input id="lastName" type="text" /><br />
		<button id="submit" type="button">Submit</button>
		<button id="delete" type="button" hidden>â˜¢ Delete â˜¢</button>
	</form>
</div>
</body>
</html>